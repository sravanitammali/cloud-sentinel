# ===========================================
# CLOUD SENTINEL - Security Scan Pipeline
# ===========================================
# This workflow runs on every push and PR to scan
# Terraform code for security misconfigurations

name: Security Scan

on:
  push:
    branches: [main, master, develop]
    paths:
      - "terraform/**"
      - ".github/workflows/security-scan.yml"
  pull_request:
    branches: [main, master]
    paths:
      - "terraform/**"
  workflow_dispatch: # Allow manual trigger

env:
  TERRAFORM_VERSION: "1.6.0"
  PYTHON_VERSION: "3.11"

jobs:
  # -------------------------------------------
  # Job 1: Security Scan with Checkov
  # -------------------------------------------
  security-scan:
    name: Checkov Security Scan
    runs-on: ubuntu-latest

    outputs:
      scan_status: ${{ steps.scan.outputs.status }}
      violations_found: ${{ steps.scan.outputs.violations }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install checkov

      - name: Run Checkov Scan
        id: checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: terraform/
          framework: terraform
          output_format: cli,json
          output_file_path: console,checkov_results.json
          soft_fail: true # Don't fail the job for demo purposes
          download_external_modules: true
          config_file: .checkov.yaml

      - name: Process Scan Results
        id: scan
        run: |
          echo "Processing Checkov scan results..."

          if [ -f "checkov_results.json" ]; then
            # Count violations using a more robust method
            FAILED=$(python3 -c "
          import json, sys, os
          try:
              with open('checkov_results.json', 'r') as f:
                  data = json.load(f)
              
              total_failed = 0
              if isinstance(data, list):
                  for item in data:
                      if 'results' in item and 'failed_checks' in item['results']:
                          total_failed += len(item['results']['failed_checks'])
              elif isinstance(data, dict):
                  if 'results' in data and 'failed_checks' in data['results']:
                      total_failed = len(data['results']['failed_checks'])
              
              print(total_failed)
          except Exception as e:
              print('0')
          " 2>/dev/null || echo "0")
            
            echo "violations=$FAILED" >> $GITHUB_OUTPUT
            echo "Found $FAILED security violations"
            
            if [ "$FAILED" -gt "0" ]; then
              echo "status=failed" >> $GITHUB_OUTPUT
              echo "::warning::ðŸš¨ Found $FAILED security violations! This demonstrates our scanner working correctly."
            else
              echo "status=passed" >> $GITHUB_OUTPUT
              echo "::notice::âœ… No security violations found!"
            fi
          else
            echo "status=unknown" >> $GITHUB_OUTPUT
            echo "violations=0" >> $GITHUB_OUTPUT
            echo "::warning::Checkov results file not found"
          fi

      - name: Upload Scan Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: checkov-results
          path: checkov_results.json
          retention-days: 30

      - name: Create Summary
        if: always()
        run: |
          echo "## ðŸ›¡ï¸ Cloud Sentinel Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ${{ steps.scan.outputs.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Violations Found | **${{ steps.scan.outputs.violations }}** |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.scan.outputs.status }}" == "failed" ]; then
            echo "### ðŸš¨ Security Issues Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**${{ steps.scan.outputs.violations }} security violations found!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "This demonstrates our DevSecOps scanner successfully detecting:" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”“ Open SSH access (0.0.0.0/0)" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”’ Unencrypted storage volumes" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸŒ Public database access" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”‘ Overly permissive IAM policies" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“¦ Insecure S3 bucket configurations" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "In production, these violations would block deployment until resolved." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… No Security Issues Found" >> $GITHUB_STEP_SUMMARY
            echo "All infrastructure configurations passed security validation." >> $GITHUB_STEP_SUMMARY
          fi

  # -------------------------------------------
  # Job 2: Terraform Validation
  # -------------------------------------------
  terraform-validate:
    name: Terraform Validate
    runs-on: ubuntu-latest
    needs: security-scan

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        working-directory: terraform
        run: terraform init -backend=false

      - name: Terraform Validate
        working-directory: terraform
        run: terraform validate

      - name: Terraform Format Check
        working-directory: terraform
        run: terraform fmt -check -recursive
        continue-on-error: true

  # -------------------------------------------
  # Job 3: Gate Check (Block on Critical Issues)
  # -------------------------------------------
  gate-check:
    name: Security Gate
    runs-on: ubuntu-latest
    needs: [security-scan, terraform-validate]
    if: always()

    steps:
      - name: Check Security Gate
        run: |
          echo "## ðŸš¦ Security Gate Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          VIOLATIONS="${{ needs.security-scan.outputs.violations_found }}"
          STATUS="${{ needs.security-scan.outputs.scan_status }}"

          echo "**Violations Found:** $VIOLATIONS" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Status:** $STATUS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # For demo purposes, we warn but don't block
          # In production, you would fail the job here
          if [ "$STATUS" == "failed" ] && [ "$VIOLATIONS" -gt "0" ]; then
            echo "### ðŸš¨ Security Gate: VIOLATIONS DETECTED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**$VIOLATIONS security violations found in infrastructure code!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ” **This demonstrates our DevSecOps scanner working correctly:**" >> $GITHUB_STEP_SUMMARY
            echo "- Automatically detected security misconfigurations" >> $GITHUB_STEP_SUMMARY
            echo "- Scanned Infrastructure-as-Code before deployment" >> $GITHUB_STEP_SUMMARY
            echo "- Would block insecure infrastructure in production" >> $GITHUB_STEP_SUMMARY
            echo "- Provides detailed violation reports for remediation" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **In production environment, this pipeline would FAIL and block deployment.**" >> $GITHUB_STEP_SUMMARY
            echo "::warning::ðŸš¨ DEMO SUCCESS: Security gate triggered - $VIOLATIONS violations detected!"
            # Uncomment the next line to actually block deployments:
            # exit 1
          else
            echo "### âœ… Security Gate: PASSED" >> $GITHUB_STEP_SUMMARY
            echo "No blocking security issues found." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Final Status
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "CLOUD SENTINEL - Pipeline Complete"
          echo "=========================================="
          echo "Security Scan: ${{ needs.security-scan.outputs.scan_status }}"
          echo "Violations: ${{ needs.security-scan.outputs.violations_found }}"
          echo "=========================================="
